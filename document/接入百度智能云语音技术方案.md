# UniApp 接入百度智能云语音技术方案 (ASR & TTS)

本文档详细描述了如何在 UniApp (H5/App) 项目中接入百度智能云的语音识别 (ASR) 和语音合成 (TTS) 服务。

**适用场景**：UniApp H5 开发环境、App 打包（需注意跨域/代理配置差异）。
**依赖库**：`recorder-core` (用于 H5 高质量录音)

---

## 1. 准备工作

### 1.1 获取百度云 API Key
确保你拥有百度智能云账号，并创建了语音技术应用，获取到：
*   **AppID**: `7414463`
*   **API Key (AK)**: `EkfYCj1AaMvyrIDDMS7QSmM2`
*   **Secret Key (SK)**: `gokF5pHjOFlkVGlilvkQioD6xn8lyu32`

### 1.2 安装依赖
在项目根目录运行：
```bash
npm install recorder-core
```

---

## 2. 核心代码实现

### 2.1 配置 Vite 代理 (解决 H5 跨域)
修改 `vite.config.js`，添加代理转发规则，将请求转发到百度服务器。

```javascript
// vite.config.js
import { defineConfig } from 'vite';
import uni from '@dcloudio/vite-plugin-uni';

export default defineConfig({
  plugins: [uni()],
  server: {
    proxy: {
      '/baidu-auth': {
        target: 'https://aip.baidubce.com',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/baidu-auth/, '')
      },
      '/baidu-asr': {
        target: 'https://vop.baidu.com',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/baidu-asr/, '')
      },
      '/baidu-tts': {
        target: 'https://tsn.baidu.com',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/baidu-tts/, '')
      }
    }
  }
});
```

### 2.2 封装录音工具类 (`utils/h5-recorder.js`)
百度 ASR 强制要求：**16000Hz 采样率、16位深、单声道、WAV/PCM 格式**。
`recorder-core` 可以完美满足这些参数。

```javascript
// utils/h5-recorder.js
import Recorder from 'recorder-core'
import 'recorder-core/src/engine/wav'

class H5Recorder {
  constructor() {
    this.rec = null;
  }

  start() {
    return new Promise((resolve, reject) => {
      this.rec = Recorder({
        type: "wav",
        sampleRate: 16000,
        bitRate: 16,
        onProcess: (buffers, powerLevel, bufferDuration, bufferSampleRate) => {
          // 可在此处实时处理音频数据
        }
      });

      this.rec.open(() => {
        this.rec.start();
        console.log("录音已开始");
        resolve();
      }, (msg, isUserNotAllow) => {
        console.error("无法录音:" + msg);
        reject(msg);
      });
    });
  }

  stop() {
    return new Promise((resolve, reject) => {
      if (!this.rec) {
        reject("未开始录音");
        return;
      }

      this.rec.stop((blob, duration) => {
        console.log("录音结束", blob, duration);
        
        // 读取Blob并转换为Base64
        const reader = new FileReader();
        reader.onloadend = () => {
          const base64 = reader.result.split(',')[1]; // 去掉前缀
          resolve({
            blob: blob,
            base64: base64,
            size: blob.size,
            duration: duration
          });
        };
        reader.onerror = (e) => {
          reject(e);
        };
        reader.readAsDataURL(blob);
        
        // 关闭录音，释放资源
        this.rec.close();
        this.rec = null;
      }, (msg) => {
        console.error("录音失败:" + msg);
        reject(msg);
      });
    });
  }
}

export default new H5Recorder();
```

### 2.3 封装百度 API 服务 (`services/baiduAuth.js`)
处理 Token 获取与缓存、语音识别请求、语音合成请求。

```javascript
// services/baiduAuth.js
const AK = 'EkfYCj1AaMvyrlDDMS7QSmM2';
const SK = 'gokF5pHjOFIkVGIiIvkQioD6xn8lyu32';

let accessToken = '';
let tokenExpiresTime = 0;

/**
 * 获取 Access Token
 */
export const getToken = () => {
  return new Promise((resolve, reject) => {
    // 检查缓存是否有效
    if (accessToken && Date.now() < tokenExpiresTime) {
      resolve(accessToken);
      return;
    }

    uni.request({
      url: '/baidu-auth/oauth/2.0/token',
      method: 'POST',
      data: {
        grant_type: 'client_credentials',
        client_id: AK,
        client_secret: SK
      },
      header: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      success: (res) => {
        if (res.data && res.data.access_token) {
          accessToken = res.data.access_token;
          // 有效期默认30天，这里保守设置减去1小时
          tokenExpiresTime = Date.now() + (res.data.expires_in * 1000) - 3600000;
          resolve(accessToken);
        } else {
          reject('Failed to get token: ' + JSON.stringify(res.data));
        }
      },
      fail: (err) => {
        reject(err);
      }
    });
  });
};

/**
 * 语音识别 (Voice to Text)
 * @param {string} base64Audio 录音文件的Base64字符串 (不带前缀)
 * @param {number} len 文件字节长度
 */
export const voice2Text = async (base64Audio, len) => {
  try {
    const token = await getToken();
    
    return new Promise((resolve, reject) => {
      uni.request({
        url: '/baidu-asr/server_api',
        method: 'POST',
        header: {
          'Content-Type': 'application/json'
        },
        data: {
          format: 'wav',
          rate: 16000,
          channel: 1,
          cuid: 'blindwolf_user_' + Math.random().toString(36).substring(7),
          token: token,
          dev_pid: 1537, // 普通话
          speech: base64Audio,
          len: len
        },
        success: (res) => {
          if (res.data && res.data.err_no === 0) {
            resolve(res.data.result[0]);
          } else {
            reject('ASR Error: ' + JSON.stringify(res.data));
          }
        },
        fail: (err) => {
          reject(err);
        }
      });
    });
  } catch (e) {
    return Promise.reject(e);
  }
};

/**
 * 语音合成 (Text to Voice)
 * @param {string} text 要合成的文本
 */
export const text2Voice = async (text) => {
  try {
    const token = await getToken();

    return new Promise((resolve, reject) => {
      // 注意：这里 uni.request 需要设置 responseType 为 arraybuffer
      uni.request({
        url: '/baidu-tts/text2audio',
        method: 'POST',
        header: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        data: {
          tex: encodeURIComponent(text),
          lan: 'zh',
          cuid: 'blindwolf_user_' + Math.random().toString(36).substring(7),
          ctp: 1,
          tok: token,
          spd: 5,
          pit: 5,
          vol: 5,
          per: 0 // 发音人选择
        },
        responseType: 'arraybuffer',
        success: (res) => {
            const contentType = res.header['Content-Type'] || res.header['content-type'];
            if (contentType && contentType.includes('application/json')) {
                 const decoder = new TextDecoder('utf-8');
                 const jsonString = decoder.decode(res.data);
                 reject('TTS Error: ' + jsonString);
                 return;
            }
            const blob = new Blob([res.data], { type: 'audio/mp3' });
            const audioUrl = URL.createObjectURL(blob);
            resolve(audioUrl);
        },
        fail: (err) => {
          reject(err);
        }
      });
    });
  } catch (e) {
    return Promise.reject(e);
  }
};
```

---

## 3. 快速接入 Prompt (给 AI IDE 的指令)

如果你需要在新的项目中使用 AI 快速复现此功能，请复制以下 Prompt 发送给 AI：

```markdown
请帮我在 UniApp H5 项目中接入百度云语音服务 (ASR 和 TTS)。

**环境信息**：
- 框架：UniApp (Vue3 + Vite)
- 运行环境：H5 (Localhost)

**配置信息**：
- API Key: EkfYCj1AaMvyrlDDMS7QSmM2
- Secret Key: gokF5pHjOFIkVGIiIvkQioD6xn8lyu32
- 代理路径：
  - /baidu-auth -> https://aip.baidubce.com
  - /baidu-asr -> https://vop.baidu.com
  - /baidu-tts -> https://tsn.baidu.com

**任务要求**：
1. 配置 `vite.config.js` 代理解决跨域。
2. 创建 `utils/h5-recorder.js`：封装 `recorder-core` 库，实现 16000Hz/16bit/单声道 WAV 录音，并返回 Base64 (不带前缀)。
3. 创建 `services/baiduAuth.js`：
   - 实现 AccessToken 获取与缓存。
   - 实现 `voice2Text(base64, len)`：调用 ASR 接口。
   - 实现 `text2Voice(text)`：调用 TTS 接口，返回 Blob URL。
4. 提供一个简单的测试页面代码。

请直接生成代码文件。
```
